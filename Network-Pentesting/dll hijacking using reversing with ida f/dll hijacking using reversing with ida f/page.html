<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>DLL Hijacking using Reversing with IDA Free</title>
</head><body><img src="1.png" /><br/>
<br/>
<br/>
<img src="1 2.png" /><br/>
<br/>
<br/>
<img src="1 3.png" /><br/>
<br/>
<br/>
Prima cosa: avviamo ProcMon:<br/>
<img src="1 4.png" /><br/>
<br/>
Aggiungiamo dei filtri:<br/>
<img src="1 5.png" /><br/>
<br/>
Questa è la nostra DLL scelta da analizzare:<br/>
<img src="1 6.png" /><br/>
<br/>
<br/>
Ora trasciniamo l'applicazione da noi scelta (quella di Karpersky)<br/>
sul programma IDA Free:<br/>
Eseguiamo l'analisi di default.<br/>
<br/>
<br/>
Una volta caricato completamente,<br/>
cerchiamo nelle stringhe la nostra libreria scelta:<br/>
<img src="1 7.png" /><br/>
<br/>
<br/>
Il nostro scopo è questo:<br/>
trovare una funzione usata dalla DLL all'avvio<br/>
o una che possa essere usata da un interazione utente.<br/>
<br/>
<br/>
Prima di tutto,<br/>
prendiamo il nostro Metasploit loader<br/>
e cambiamo alcuni elementi:<br/>
cambiamo il nome della funzione main con il nome della funzione scelta!<br/>
<br/>
<br/>
In IDA, una volta completato, possiamo cercare nella DLL:<br/>
<img src="1 8.png" /><br/>
<br/>
<br/>
Notiamo che usa LoadLibrary!<br/>
<img src="1 9.png" /><br/>
<br/>
Vediamo se usa altre funzioni utili.<br/>
<img src="1 11.png" /><br/>
<br/>
<br/>
Se fai right click sulla funzione in giallo,<br/>
possiamo vedere dove è stata chiamata!<br/>
<img src="1 10.png" /><br/>
<img src="1 12.png" /><br/>
<img src="1 13.png" /><br/>
<br/>
<br/>
<br/>
Mettiamo un breakpoint:<br/>
<img src="1 14.png" /><br/>
<br/>
Mettiamo un Breakpoint anche a LoadLibrary:<br/>
<img src="1 15.png" /><br/>
<br/>
<br/>
Ora startiamo il processo:<br/>
<img src="1 16.png" /><br/>
<br/>
<br/>
<br/>
<img src="1 17.png" /><br/>
<br/>
<br/>
Continuiamo l'esecuzione con F8:<br/>
<img src="1 18.png" /><br/>
<br/>
Arriva tranquillamente qui:<br/>
basta che trova un API qualsiasi chiamata msi.dll per saltare il flusso<br/>
fino ad arrivare qui.<br/>
<img src="1 19.png" /><br/>
<br/>
Tornando al main.c, chiamiamo il main.c<br/>
come la funzione chiamata sopra "MsiGetProductInfoA":<br/>
In questo modo, sicuramente verrà chiamato!<br/>
<img src="1 20.png" /><br/>
<br/>
<img src="1 22.png" /><br/>
<br/>
<img src="1 21.png" /><br/>
<br/>
<br/>
Setuppa l'handler ed il gioco è fatto!<br/>
Basta far eseguire l'applicazione all'utente,<br/>
quando chiama la funzione scelta si connetterà!</body></html>